<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/dVfJC4b8/android-chrome-512x512.png">
<title>Sistema de Reservas de Salas | Sua Sala Cravinhos</title>

<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
@import url("https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap");

* {
margin: 0px;
padding: 0px;
box-sizing: border-box;
font-family: "Jost", sans-serif;
}

body {
background: linear-gradient(135deg, #faf8f5 0%, #f5f1eb 50%, #ede7dc 100%);
min-height: 100vh;
color: #6b5b47;
}

.navbar {
background: rgba(255, 255, 255, 0.98);
backdrop-filter: blur(15px);
box-shadow: 0 2px 25px rgba(139, 115, 85, 0.08);
border-bottom: 1px solid rgba(139, 115, 85, 0.1);
}

.navbar-brand {
font-weight: 600;
color: #8b7355 !important;
font-size: 1.3rem;
}

.btn-logout {
background: linear-gradient(135deg, #e8ddd4 0%, #d4c4b0 100%);
border: 1px solid rgba(139, 115, 85, 0.2);
color: #8b7355;
padding: 8px 20px;
border-radius: 30px;
transition: all 0.3s ease;
font-weight: 500;
}

.btn-logout:hover {
transform: translateY(-1px);
box-shadow: 0 8px 25px rgba(139, 115, 85, 0.15);
background: linear-gradient(135deg, #d4c4b0 0%, #c4b49f 100%);
color: #6b5b47;
}

.container-fluid {
padding: 25px;
}

.card {
border: none;
border-radius: 20px;
box-shadow: 0 8px 35px rgba(139, 115, 85, 0.08);
backdrop-filter: blur(10px);
background: rgba(255, 255, 255, 0.98);
border: 1px solid rgba(255, 255, 255, 0.3);
}

.card-header {
background: linear-gradient(135deg, #f0e6d6 0%, #e8ddd4 100%);
color: #8b7355;
border-radius: 20px 20px 0 0 !important;
padding: 25px;
border-bottom: 1px solid rgba(139, 115, 85, 0.1);
}

.card-header h4, .card-header h5 {
font-weight: 600;
margin: 0;
}

.btn-primary {
background: linear-gradient(135deg, #e8ddd4 0%, #d4c4b0 100%);
border: 1px solid rgba(139, 115, 85, 0.2);
color: #8b7355;
border-radius: 30px;
padding: 12px 28px;
transition: all 0.3s ease;
font-weight: 500;
}

.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(139, 115, 85, 0.15);
background: linear-gradient(135deg, #d4c4b0 0%, #c4b49f 100%);
color: #6b5b47;
border-color: rgba(139, 115, 85, 0.3);
}

.btn-primary:disabled {
background: rgba(139, 115, 85, 0.3);
border-color: rgba(139, 115, 85, 0.2);
color: rgba(255, 255, 255, 0.7);
transform: none;
cursor: not-allowed;
}

.btn-success {
background: linear-gradient(135deg, #d9e5d6 0%, #c4d4c0 100%);
border: 1px solid rgba(139, 115, 85, 0.2);
color: #6b7c5d;
border-radius: 30px;
transition: all 0.3s ease;
font-weight: 500;
}

.btn-success:hover {
background: linear-gradient(135deg, #c4d4c0 0%, #b3c7ae 100%);
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(107, 124, 93, 0.15);
color: #5a6b51;
}

.btn-warning {
background: linear-gradient(135deg, #f5e6d3 0%, #e8d4b8 100%);
border: 1px solid rgba(139, 115, 85, 0.2);
color: #8b7355;
border-radius: 30px;
transition: all 0.3s ease;
font-weight: 500;
}

.btn-warning:hover {
background: linear-gradient(135deg, #e8d4b8 0%, #dbc7a5 100%);
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(139, 115, 85, 0.15);
color: #6b5b47;
}

.btn-danger {
background: linear-gradient(135deg, #f0d6d6 0%, #e8c4c4 100%);
border: 1px solid rgba(139, 115, 85, 0.2);
color: #8b5555;
border-radius: 30px;
transition: all 0.3s ease;
font-weight: 500;
}

.btn-danger:hover {
background: linear-gradient(135deg, #e8c4c4 0%, #dbb3b3 100%);
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(139, 85, 85, 0.15);
color: #6b4747;
}

.btn-secondary {
background: linear-gradient(135deg, #e8e8e8 0%, #d4d4d4 100%);
border: 1px solid rgba(139, 115, 85, 0.2);
color: #8b7355;
border-radius: 30px;
transition: all 0.3s ease;
font-weight: 500;
}

.btn-secondary:hover {
background: linear-gradient(135deg, #d4d4d4 0%, #c4c4c4 100%);
transform: translateY(-2px);
color: #6b5b47;
}

.form-control, .form-select {
border-radius: 15px;
border: 2px solid rgba(139, 115, 85, 0.15);
transition: all 0.3s ease;
background: rgba(255, 255, 255, 0.9);
color: #6b5b47;
padding: 12px 16px;
}

.form-control:focus, .form-select:focus {
border-color: rgba(139, 115, 85, 0.4);
box-shadow: 0 0 0 0.2rem rgba(139, 115, 85, 0.1);
background: rgba(255, 255, 255, 1);
}

.form-label {
color: #8b7355;
font-weight: 500;
margin-bottom: 8px;
}

.table {
border-radius: 15px;
overflow: hidden;
background: rgba(255, 255, 255, 0.9);
}

.table thead th {
background: linear-gradient(135deg, #f0e6d6 0%, #e8ddd4 100%);
color: #8b7355;
border: none;
font-weight: 600;
padding: 18px 15px;
}

.table tbody td {
padding: 15px;
border-color: rgba(139, 115, 85, 0.1);
color: #6b5b47;
}

.table-hover tbody tr:hover {
background-color: rgba(240, 230, 214, 0.3);
}

#calendar {
background: rgba(255, 255, 255, 0.95);
border-radius: 20px;
padding: 25px;
box-shadow: 0 5px 20px rgba(139, 115, 85, 0.08);
border: 1px solid rgba(255, 255, 255, 0.3);
min-height: 600px;
width: 100%;
}

.fc {
width: 100%;
}

.fc-view-harness {
min-height: 500px;
}

.fc-daygrid-body {
width: 100%;
}

.fc-scrollgrid {
border: 1px solid rgba(139, 115, 85, 0.1);
border-radius: 10px;
}

.fc-col-header-cell {
background: linear-gradient(135deg, #f0e6d6 0%, #e8ddd4 100%);
color: #8b7355;
font-weight: 600;
border-color: rgba(139, 115, 85, 0.1);
}

.fc-daygrid-day {
border-color: rgba(139, 115, 85, 0.1);
}

.fc-daygrid-day:hover {
background-color: rgba(240, 230, 214, 0.3);
}

.fc-day-today {
background-color: rgba(240, 230, 214, 0.5) !important;
}

.fc-daygrid-day-number {
color: #6b5b47;
font-weight: 500;
}

.fc-event {
border-radius: 10px;
border: none;
padding: 4px 8px;
font-weight: 500;
}

.fc-button-primary {
background: linear-gradient(135deg, #e8ddd4 0%, #d4c4b0 100%) !important;
border-color: rgba(139, 115, 85, 0.2) !important;
color: #8b7355 !important;
}

.fc-button-primary:hover {
background: linear-gradient(135deg, #d4c4b0 0%, #c4b49f 100%) !important;
border-color: rgba(139, 115, 85, 0.3) !important;
}

.fc-button-primary:disabled {
background: rgba(139, 115, 85, 0.1) !important;
border-color: rgba(139, 115, 85, 0.1) !important;
color: rgba(139, 115, 85, 0.5) !important;
}

.modal-content {
border-radius: 20px;
border: none;
box-shadow: 0 15px 50px rgba(139, 115, 85, 0.15);
}

.modal-header {
background: linear-gradient(135deg, #f0e6d6 0%, #e8ddd4 100%);
color: #8b7355;
border-radius: 20px 20px 0 0;
border-bottom: 1px solid rgba(139, 115, 85, 0.1);
padding: 25px;
}

.modal-body {
padding: 25px;
background: rgba(255, 255, 255, 0.98);
}

.modal-footer {
padding: 20px 25px;
border-top: 1px solid rgba(139, 115, 85, 0.1);
background: rgba(250, 248, 245, 0.8);
border-radius: 0 0 20px 20px;
}

.loading {
display: none;
text-align: center;
padding: 30px;
}

.spinner-border {
color: #d4c4b0;
}

.alert {
border-radius: 15px;
border: none;
background: rgba(240, 230, 214, 0.8);
color: #8b7355;
border: 1px solid rgba(139, 115, 85, 0.2);
}

.alert-danger {
background: rgba(240, 214, 214, 0.8);
color: #8b5555;
border: 1px solid rgba(139, 85, 85, 0.2);
}

.alert-success {
background: rgba(217, 229, 214, 0.8);
color: #6b7c5d;
border: 1px solid rgba(107, 124, 93, 0.2);
}

.nav-tabs {
border-bottom: 2px solid rgba(139, 115, 85, 0.1);
}

.nav-tabs .nav-link {
border-radius: 15px 15px 0 0;
border: none;
color: #8b7355;
font-weight: 500;
padding: 15px 25px;
margin-right: 5px;
background: rgba(255, 255, 255, 0.6);
transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover {
background: rgba(240, 230, 214, 0.8);
color: #6b5b47;
}

.nav-tabs .nav-link.active {
background: linear-gradient(135deg, #f0e6d6 0%, #e8ddd4 100%);
color: #8b7355;
border-bottom: 2px solid #d4c4b0;
}

.nav-tabs .nav-link.disabled {
background: rgba(200, 200, 200, 0.5);
color: rgba(139, 115, 85, 0.5);
cursor: not-allowed;
}

.tab-content {
background: rgba(255, 255, 255, 0.95);
border-radius: 0 15px 15px 15px;
padding: 25px;
box-shadow: 0 5px 20px rgba(139, 115, 85, 0.08);
}

/* Novo Slider Styles */
.slider-container {
    width: 100%;
    height: 500px;
    background: linear-gradient(135deg, #faf8f5 0%, #f5f1eb 50%, #ede7dc 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 20px;
    overflow: hidden;
    position: relative;
    margin-bottom: 20px;
    box-shadow: 0 15px 35px rgba(139, 115, 85, 0.15);
}

.slider-images {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    width: 100%;
    overflow-x: auto;
    scroll-behavior: smooth;
    scrollbar-width: none; /* Firefox */
    cursor: grab;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

.slider-images::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
}

.slider-images:active {
    cursor: grabbing;
}

.slider-img {
    min-width: 300px;
    height: 400px;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(139, 115, 85, 0.15);
    transition: all 0.3s ease;
    position: relative;
    flex-shrink: 0;
}

.slider-img img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.slider-img:hover img {
    transform: scale(1.05);
}

.slider-details {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.9);
    padding: 15px;
    transform: translateY(100%);
    transition: transform 0.3s ease;
}

.slider-img:hover .slider-details {
    transform: translateY(0);
}

.slider-details h3 {
    color: #8b7355;
    font-weight: 600;
    margin-bottom: 5px;
}

.slider-details p {
    color: #6b5b47;
    margin-bottom: 0;
    font-size: 0.9rem;
}

.slider-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
}

.slider-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #e8ddd4 0%, #d4c4b0 100%);
    border: 1px solid rgba(139, 115, 85, 0.2);
    color: #8b7355;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

.slider-btn:hover:not([style*="not-allowed"]) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(139, 115, 85, 0.15);
    background: linear-gradient(135deg, #d4c4b0 0%, #c4b49f 100%);
    color: #6b5b47;
}

.slider-btn:active:not([style*="not-allowed"]) {
    transform: translateY(0);
    box-shadow: 0 4px 15px rgba(139, 115, 85, 0.1);
}

@media (max-width: 768px) {
    .slider-container {
        height: 400px;
    }

    .slider-img {
        min-width: 250px;
        height: 350px;
    }
}

@media (max-width: 576px) {
    .slider-container {
        height: 350px;
    }

    .slider-img {
        min-width: 220px;
        height: 300px;
    }
}

/* Access Control Styles */
.access-locked {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
height: 60vh;
text-align: center;
color: #8b7355;
background: rgba(240, 230, 214, 0.3);
border-radius: 15px;
border: 2px dashed rgba(139, 115, 85, 0.3);
}

.access-locked i {
font-size: 4rem;
margin-bottom: 1rem;
opacity: 0.6;
}

.access-locked h3 {
margin-bottom: 1rem;
font-weight: 600;
}

.access-locked p {
opacity: 0.8;
max-width: 400px;
margin-bottom: 1.5rem;
}

.access-locked .contact-info {
background: rgba(255, 255, 255, 0.8);
padding: 15px 20px;
border-radius: 10px;
border: 1px solid rgba(139, 115, 85, 0.2);
}

.access-locked .contact-info strong {
color: #6b5b47;
}

/* User type indicator */
.user-type-badge {
background: linear-gradient(135deg, #d9e5d6 0%, #c4d4c0 100%);
color: #6b7c5d;
padding: 4px 12px;
border-radius: 15px;
font-size: 0.8rem;
font-weight: 500;
margin-left: 10px;
}

.user-type-badge.admin {
background: linear-gradient(135deg, #f5e6d3 0%, #e8d4b8 100%);
color: #8b7355;
}

/* Loading screen */
.loading-screen {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: linear-gradient(135deg, #faf8f5 0%, #f5f1eb 50%, #ede7dc 100%);
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
z-index: 9999;
}

.loading-screen .spinner-border {
width: 3rem;
height: 3rem;
color: #8b7355;
}

.loading-screen p {
margin-top: 20px;
color: #8b7355;
font-weight: 500;
}

.loading-screen .retry-btn {
margin-top: 20px;
background: linear-gradient(135deg, #e8ddd4 0%, #d4c4b0 100%);
border: 1px solid rgba(139, 115, 85, 0.2);
color: #8b7355;
padding: 10px 20px;
border-radius: 25px;
cursor: pointer;
font-weight: 500;
transition: all 0.3s ease;
}

.loading-screen .retry-btn:hover {
background: linear-gradient(135deg, #d4c4b0 0%, #c4b49f 100%);
transform: translateY(-1px);
}

/* Button loading spinner */
.btn-loading {
position: relative;
}

.btn-loading .btn-spinner {
position: absolute;
left: 50%;
top: 50%;
transform: translate(-50%, -50%);
width: 16px;
height: 16px;
border: 2px solid rgba(255, 255, 255, 0.3);
border-radius: 50%;
border-top-color: #fff;
animation: spin 1s ease-in-out infinite;
}

.btn-loading .btn-text {
opacity: 0;
}

@keyframes spin {
to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* User info display */
.user-info {
display: flex;
align-items: center;
gap: 10px;
padding: 8px 15px;
background: rgba(240, 230, 214, 0.3);
border-radius: 20px;
margin-right: 15px;
}

.user-info i {
color: #8b7355;
}

.user-info span {
color: #6b5b47;
font-weight: 500;
font-size: 0.9rem;
}

/* Smooth transitions for all interactive elements */
.btn, .card, .form-control, .nav-link {
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
width: 8px;
}

::-webkit-scrollbar-track {
background: rgba(139, 115, 85, 0.1);
border-radius: 10px;
}

::-webkit-scrollbar-thumb {
background: rgba(139, 115, 85, 0.3);
border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
background: rgba(139, 115, 85, 0.5);
}

/* Reservas históricas */
.reservation-history {
background-color: rgba(240, 230, 214, 0.3) !important;
}

.reservation-history:hover {
background-color: rgba(240, 230, 214, 0.5) !important;
}

.badge-history {
background-color: #a8a8a8 !important;
color: #4a4a4a !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
.container-fluid {
padding: 15px;
}

.card-header {
padding: 20px;
}

.tab-content {
padding: 20px;
}

.user-info span {
display: none;
}
}

/* Error and retry styles */
.error-container {
text-align: center;
padding: 20px;
}

.error-icon {
font-size: 2rem;
color: #dc3545;
margin-bottom: 10px;
}

.retry-section {
margin-top: 15px;
}

.connectivity-status {
display: inline-flex;
align-items: center;
gap: 5px;
font-size: 0.9rem;
padding: 5px 10px;
border-radius: 15px;
margin-bottom: 10px;
}

.connectivity-status.online {
background: rgba(40, 167, 69, 0.1);
color: #28a745;
}

.connectivity-status.offline {
background: rgba(220, 53, 69, 0.1);
color: #dc3545;
}

.connectivity-status.checking {
background: rgba(255, 193, 7, 0.1);
color: #ffc107;
}
</style>
</head>
<body>
<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
<div class="spinner-border" role="status">
<span class="visually-hidden">Carregando...</span>
</div>
<p id="loadingText">Verificando autenticação...</p>
<button class="retry-btn" id="retryBtn" style="display: none;" onclick="location.reload()">
Tentar Novamente
</button>
</div>

<!-- Main Content -->
<div id="mainContent" style="display: none;">
<!-- Navbar -->
<nav class="navbar navbar-expand-lg">
<div class="container-fluid">
<a class="navbar-brand" href="#">
<img src="https://i.postimg.cc/YSh3Hqtb/fav-1.png" alt="Sua Sala Cravinhos" style="height: 60px; weight: 15px; margin-right: 0px;">         
</a>
<div class="navbar-nav ms-auto d-flex align-items-center">
<div class="user-info" id="userInfo">
<i class="fas fa-user-circle"></i>
<span id="userEmail">Carregando...</span>
<span class="user-type-badge" id="userTypeBadge">Usuário</span>
</div>
<button class="btn btn-logout" id="logoutBtn">
<i class="fas fa-sign-out-alt me-1"></i>
Sair
</button>
</div>
</div>
</nav>

<div class="container-fluid">
<!-- Alert Container -->
<div id="alertContainer"></div>

<!-- Tabs Navigation -->
<ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
<li class="nav-item" role="presentation">
<button class="nav-link active" id="slider-tab" data-bs-toggle="tab" data-bs-target="#slider-pane" type="button" role="tab">
<i class="fas fa-images me-2"></i>Galeria
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar-pane" type="button" role="tab">
<i class="fas fa-calendar me-2"></i>Calendário
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="reservations-tab" data-bs-toggle="tab" data-bs-target="#reservations-pane" type="button" role="tab">
<i class="fas fa-list me-2"></i>Gerenciar Reservas
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-pane" type="button" role="tab">
<i class="fas fa-user-friends me-2"></i>Gerenciar Usuários
</button>
</li>
<!-- Nova aba de Histórico -->
<li class="nav-item" role="presentation">
<button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-pane" type="button" role="tab">
<i class="fas fa-history me-2"></i>Histórico de Reservas
</button>
</li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="mainTabContent">
<!-- Slider Tab -->
<div class="tab-pane fade show active" id="slider-pane" role="tabpanel">
    <div class="container">
        <div class="slider-container">
            <div class="slider-images" id="sliderImages">
                <div class="slider-img">
                    <img src="https://i.postimg.cc/SNzxj8PY/Whats-App-Image-2025-07-03-at-16-44-10-2.jpg" alt="Sala de Reunião A">
                    <div class="slider-details">
                        <h3>Sala de Reunião A</h3>
                        <p>Reuniões Executivas</p>
                    </div>
                </div>
                <div class="slider-img">
                    <img src="https://i.postimg.cc/FRWHkxm3/Whats-App-Image-2025-07-03-at-16-44-10-3.jpg" alt="Sala de Reunião B">
                    <div class="slider-details">
                        <h3>Sala de Reunião B</h3>
                        <p>Reuniões Gerais</p>
                    </div>
                </div>
                <div class="slider-img">
                    <img src="https://i.postimg.cc/85PCCY8T/Whats-App-Image-2025-07-03-at-16-44-11.jpg" alt="Sala de Conferência">
                    <div class="slider-details">
                        <h3>Sala de Conferência</h3>
                        <p>Videoconferências</p>
                    </div>
                </div>
                <div class="slider-img">
                    <img src="https://i.postimg.cc/pdBTRH60/Whats-App-Image-2025-07-03-at-16-44-23.jpg" alt="Auditório">
                    <div class="slider-details">
                        <h3>Auditório</h3>
                        <p>Grandes Eventos</p>
                    </div>
                </div>
                <div class="slider-img">
                    <img src="https://i.postimg.cc/j2DdHJd9/Whats-App-Image-2025-07-03-at-16-44-23-1.jpg" alt="Sala de Treinamento">
                    <div class="slider-details">
                        <h3>Sala de Treinamento</h3>
                        <p>Capacitações</p>
                    </div>
                </div>
                <div class="slider-img">
                    <img src="https://i.postimg.cc/jjT5p5Zw/Whats-App-Image-2025-07-03-at-16-44-24.jpg" alt="Espaço Coworking">
                    <div class="slider-details">
                        <h3>Espaço Coworking</h3>
                        <p>Trabalho Colaborativo</p>
                    </div>
                </div>
                <div class="slider-img">
                    <img src="https://i.postimg.cc/RZKhpfQx/Whats-App-Image-2025-07-03-at-16-44-24-1.jpg" alt="Sala Privativa">
                    <div class="slider-details">
                        <h3>Sala Privativa</h3>
                        <p>Reuniões Confidenciais</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="slider-controls">
            <div class="slider-btn" id="prevBtn">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="slider-btn" id="nextBtn">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Tab -->
<div class="tab-pane fade" id="calendar-pane" role="tabpanel">
<!-- Content will be dynamically loaded based on user permissions -->
<div id="calendarAccessContent">
<!-- This will be populated by JavaScript -->
</div>
</div>

<!-- Reservations Management Tab -->
<div class="tab-pane fade" id="reservations-pane" role="tabpanel">
<!-- Content will be dynamically loaded based on user permissions -->
<div id="reservationsAccessContent">
<!-- This will be populated by JavaScript -->
</div>
</div>

<!-- Users Management Tab -->
<div class="tab-pane fade" id="users-pane" role="tabpanel">
<div id="usersAccessContent">
<!-- This will be populated by JavaScript -->
</div>
</div>

<!-- Novo painel de Histórico -->
<div class="tab-pane fade" id="history-pane" role="tabpanel">
<div id="historyAccessContent">
<!-- This will be populated by JavaScript -->
</div>
</div>
</div>
</div>
</div>

<!-- Edit Reservation Modal -->
<div class="modal fade" id="editReservationModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">
<i class="fas fa-edit me-2"></i>
Editar Reserva
</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="editReservationForm">
<input type="hidden" id="editReservationId">
<div class="mb-3">
<label for="editClientName" class="form-label">Nome do Cliente</label>
<select class="form-select" id="editClientName" required>
<option value="">Selecione um cliente</option>
</select>
</div>
<div class="mb-3">
<label for="editRoomName" class="form-label">Sala</label>
<select class="form-select" id="editRoomName" required>
<option value="">Selecione uma sala</option>
<option value="Sala de Reunião A">Sala de Reunião A</option>
<option value="Sala de Reunião B">Sala de Reunião B</option>
<option value="Sala de Conferência">Sala de Conferência</option>
<option value="Auditório">Auditório</option>
<option value="Sala de Treinamento">Sala de Treinamento</option>
</select>
</div>
<div class="mb-3">
<label for="editReservationDate" class="form-label">Data</label>
<input type="date" class="form-control" id="editReservationDate" required>
</div>
<div class="row">
<div class="col-6">
<label for="editStartTime" class="form-label">Hora Início</label>
<input type="time" class="form-control" id="editStartTime" required>
</div>
<div class="col-6">
<label for="editEndTime" class="form-label">Hora Fim</label>
<input type="time" class="form-control" id="editEndTime" required>
</div>
</div>
<div class="mb-3 mt-3">
<label for="editScheduledBy" class="form-label">Agendado por</label>
<input type="text" class="form-control" id="editScheduledBy" required>
</div>
<div class="mb-3">
<label for="editDescription" class="form-label">Descrição (opcional)</label>
<textarea class="form-control" id="editDescription" rows="3"></textarea>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-primary" onclick="updateReservation()" id="updateReservationBtn">
<span class="btn-text">
<i class="fas fa-save me-1"></i>
Salvar Alterações
</span>
<div class="btn-spinner" style="display: none;"></div>
</button>
</div>
</div>
</div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">
<i class="fas fa-user-edit me-2"></i>
Editar Usuário
</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="editUserForm">
<input type="hidden" id="editUserId">
<div class="mb-3">
<label for="editUserName" class="form-label">Nome</label>
<input type="text" class="form-control" id="editUserName" required>
</div>
<div class="mb-3">
<label for="editUserEmail" class="form-label">Email</label>
<input type="email" class="form-control" id="editUserEmail" required>
</div>
<div class="alert alert-warning">
<i class="fas fa-exclamation-triangle me-2"></i>
<strong>Atenção:</strong> Alterar o email do usuário pode afetar o acesso ao sistema. O usuário precisará fazer login com o novo email.
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-primary" onclick="updateUser()" id="updateUserBtn">
<span class="btn-text">
<i class="fas fa-save me-1"></i>
Salvar Alterações
</span>
<div class="btn-spinner" style="display: none;"></div>
</button>
</div>
</div>
</div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<!-- Firebase Integration -->
<script type="module">
// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";

// Firebase configuration
const firebaseConfig = {
apiKey: "AIzaSyCZJNPgEE1pllmmbjqHGCobcsB_udQO7fU",
authDomain: "suasalacravinhos.firebaseapp.com",
projectId: "suasalacravinhos",
storageBucket: "suasalacravinhos.appspot.com",
messagingSenderId: "689313544330",
appId: "1:689313544330:web:1c81b55119732be02a9573",
measurementId: "G-5JW5YJRQ01"
};

// Global variables
let app, auth, db;
let calendar;
let currentUser = null;
let reservationsData = new Map();
let usersData = new Map();
let authCheckTimeout;
let userType = 'user'; // 'user' or 'admin'

// Initialize Firebase with timeout and error handling
async function initializeFirebase() {
try {
console.log("Inicializando Firebase...");
app = initializeApp(firebaseConfig);
auth = getAuth(app);
db = getFirestore(app);

// Set timeout for auth check
authCheckTimeout = setTimeout(() => {
console.log("Timeout na verificação de autenticação");
document.getElementById('loadingText').textContent = 'Erro de conexão. Clique em "Tentar Novamente" ou vá para o login.';
document.getElementById('retryBtn').style.display = 'block';

// Add login button
const loginBtn = document.createElement('button');
loginBtn.className = 'retry-btn';
loginBtn.textContent = 'Ir para Login';
loginBtn.style.marginLeft = '10px';
loginBtn.onclick = () => window.location.href = "login.html";
document.getElementById('retryBtn').parentNode.appendChild(loginBtn);
}, 10000); // 10 seconds timeout

// Check authentication state
onAuthStateChanged(auth, (user) => {
clearTimeout(authCheckTimeout);
const loadingScreen = document.getElementById('loadingScreen');
const mainContent = document.getElementById('mainContent');

console.log("Estado de autenticação:", user ? "Logado" : "Não logado");

if (user) {
// User is signed in
currentUser = user;
document.getElementById('userEmail').textContent = user.email;

// Determine user type based on email
if (user.email === 'admin@admin.com.br') {
userType = 'admin';
} else {
userType = 'user';
}

// Setup access control based on user type
setupAccessControl();

// Hide loading screen and show main content
loadingScreen.style.display = 'none';
mainContent.style.display = 'block';

// Initialize the application
initializeReservationApp();
} else {
// User is not signed in, redirect to login
console.log("Redirecionando para login...");
window.location.href = "login.html";
}
}, (error) => {
console.error("Erro na verificação de autenticação:", error);
clearTimeout(authCheckTimeout);
document.getElementById('loadingText').textContent = 'Erro de autenticação. Redirecionando para login...';
setTimeout(() => {
window.location.href = "login.html";
}, 2000);
});

} catch (error) {
console.error("Erro ao inicializar Firebase:", error);
clearTimeout(authCheckTimeout);
document.getElementById('loadingText').textContent = 'Erro de conexão. Redirecionando para login...';
setTimeout(() => {
window.location.href = "login.html";
}, 2000);
}
}

// Test Firebase connectivity
async function testFirebaseConnectivity() {
try {
console.log("Testando conectividade com Firebase...");

// Test authentication state
if (!auth || !currentUser) {
throw new Error("Usuário não autenticado");
}

// Test Firestore connection with a simple read
const testDoc = doc(db, "test", "connectivity");
await getDoc(testDoc);

console.log("Conectividade com Firebase OK");
return true;
} catch (error) {
console.error("Erro de conectividade com Firebase:", error);
return false;
}
}

// Enhanced error handling for Firebase operations
function getFirebaseErrorMessage(error) {
console.error("Detalhes do erro Firebase:", error);

switch (error.code) {
case 'permission-denied':
return 'Acesso negado. Verifique as permissões do usuário.';
case 'unavailable':
return 'Serviço temporariamente indisponível. Tente novamente em alguns minutos.';
case 'unauthenticated':
return 'Usuário não autenticado. Faça login novamente.';
case 'failed-precondition':
return 'Configuração do banco de dados incompleta. Contate o administrador.';
case 'not-found':
return 'Dados não encontrados no banco de dados.';
case 'deadline-exceeded':
case 'timeout':
return 'Timeout na conexão. Verifique sua conexão com a internet.';
case 'network-request-failed':
return 'Falha na conexão de rede. Verifique sua conexão com a internet.';
default:
if (error.message.includes('network')) {
return 'Problema de conectividade. Verifique sua conexão com a internet.';
} else if (error.message.includes('Firebase')) {
return 'Erro no serviço Firebase. Tente novamente mais tarde.';
} else {
return `Erro inesperado: ${error.message}`;
}
}
}

// Show alert messages
function showAlert(message, type = 'info') {
const alertContainer = document.getElementById('alertContainer');
const alertId = 'alert-' + Date.now();

const alertHtml = `
<div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
${message}
<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
`;

alertContainer.insertAdjacentHTML('beforeend', alertHtml);

// Auto-remove after 5 seconds
setTimeout(() => {
const alertEl = document.getElementById(alertId);
if (alertEl) {
const bsAlert = new bootstrap.Alert(alertEl);
bsAlert.close();
}
}, 5000);
}

// Set button loading state
function setButtonLoading(buttonId, loading) {
const button = document.getElementById(buttonId);
if (!button) return;

const btnText = button.querySelector('.btn-text');
const btnSpinner = button.querySelector('.btn-spinner');

if (loading) {
button.disabled = true;
button.classList.add('btn-loading');
if (btnText) btnText.style.opacity = '0';
if (btnSpinner) btnSpinner.style.display = 'block';
} else {
button.disabled = false;
button.classList.remove('btn-loading');
if (btnText) btnText.style.opacity = '1';
if (btnSpinner) btnSpinner.style.display = 'none';
}
}

// Setup access control based on user type
function setupAccessControl() {
const userTypeBadge = document.getElementById('userTypeBadge');
const calendarTab = document.getElementById('calendar-tab').parentElement;
const reservationsTab = document.getElementById('reservations-tab').parentElement;
const usersTab = document.getElementById('users-tab').parentElement;
const historyTab = document.getElementById('history-tab').parentElement;
const calendarAccessContent = document.getElementById('calendarAccessContent');
const reservationsAccessContent = document.getElementById('reservationsAccessContent');
const usersAccessContent = document.getElementById('usersAccessContent');
const historyAccessContent = document.getElementById('historyAccessContent');

if (userType === 'admin') {
// Admin has full access
userTypeBadge.textContent = 'Administrador';
userTypeBadge.classList.add('admin');

// Show all tabs for admin
calendarTab.style.display = 'block';
reservationsTab.style.display = 'block';
usersTab.style.display = 'block';
historyTab.style.display = 'block';

// Load full calendar content
calendarAccessContent.innerHTML = getCalendarContent();

// Load full reservations content
reservationsAccessContent.innerHTML = getReservationsContent();

// Load users management content
usersAccessContent.innerHTML = getUsersContent();

// Load history content
historyAccessContent.innerHTML = getHistoryContent();

console.log("Acesso completo concedido para administrador:", currentUser.email);
} else {
// Regular user - only gallery access
userTypeBadge.textContent = 'Usuário';

// Hide tabs for regular users
calendarTab.style.display = 'none';
reservationsTab.style.display = 'none';
usersTab.style.display = 'none';
historyTab.style.display = 'none';

// Clear content
calendarAccessContent.innerHTML = '';
reservationsAccessContent.innerHTML = '';
usersAccessContent.innerHTML = '';
historyAccessContent.innerHTML = '';

console.log("Acesso limitado à galeria para usuário:", currentUser.email);
}

// Initialize slider functionality
initializeNewSlider();
}

// Get users management content
function getUsersContent() {
return `
<div class="row">
<div class="col-12">
<div class="card">
<div class="card-header d-flex justify-content-between align-items-center">
<h5 class="mb-0">
<i class="fas fa-user-friends me-2"></i>
Usuários Cadastrados
</h5>
<button class="btn btn-success" onclick="loadUsers()">
<i class="fas fa-sync-alt me-1"></i>
Atualizar
</button>
</div>
<div class="card-body">
<div class="loading" id="loadingUsers">
<div class="spinner-border" role="status">
<span class="visually-hidden">Carregando...</span>
</div>
<p class="mt-2">Carregando usuários...</p>
</div>
<div class="table-responsive">
<table class="table table-hover">
<thead>
<tr>
<th>Nome</th>
<th>Email</th>
<th>Data de Cadastro</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="usersTableBody">
<!-- Users will be loaded here -->
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
`;
}

// Get history content for admin users
function getHistoryContent() {
return `
<div class="row">
<div class="col-12">
<div class="card">
<div class="card-header d-flex justify-content-between align-items-center">
<h5 class="mb-0">
<i class="fas fa-history me-2"></i>
Histórico de Reservas
</h5>
<button class="btn btn-success" onclick="loadHistory()">
<i class="fas fa-sync-alt me-1"></i>
Atualizar
</button>
</div>
<div class="card-body">
<div class="loading" id="loadingHistory">
<div class="spinner-border" role="status">
<span class="visually-hidden">Carregando...</span>
</div>
<p class="mt-2">Carregando histórico...</p>
</div>
<div class="table-responsive">
<table class="table table-hover">
<thead>
<tr>
<th>Cliente</th>
<th>Sala</th>
<th>Data</th>
<th>Horário</th>
<th>Status</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="historyTableBody">
<!-- History will be loaded here -->
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
`;
}

// Get reservations content for admin users
function getReservationsContent() {
return `
<div class="row">
<!-- Add Reservation Form -->
<div class="col-md-4">
<div class="card">
<div class="card-header">
<h5 class="mb-0">
<i class="fas fa-plus me-2"></i>
Nova Reserva
</h5>
</div>
<div class="card-body">
<form id="reservationForm">
<div class="mb-3">
<label for="clientName" class="form-label">Nome do Cliente</label>
<input type="text" class="form-control" id="clientSearch" placeholder="Pesquisar cliente..." autocomplete="off">
<select class="form-select mt-2" id="clientName" required>
<option value="">Selecione um cliente</option>
</select>
</div>
<div class="mb-3">
<label for="roomName" class="form-label">Sala</label>
<select class="form-select" id="roomName" required>
<option value="">Selecione uma sala</option>
<option value="Sala de Reunião A">Sala de Reunião A</option>
<option value="Sala de Reunião B">Sala de Reunião B</option>
<option value="Sala de Conferência">Sala de Conferência</option>
<option value="Auditório">Auditório</option>
<option value="Sala de Treinamento">Sala de Treinamento</option>
</select>
</div>
<div class="mb-3">
<label for="reservationDate" class="form-label">Data</label>
<input type="date" class="form-control" id="reservationDate" required>
</div>
<div class="row">
<div class="col-6">
<label for="startTime" class="form-label">Hora Início</label>
<input type="time" class="form-control" id="startTime" required>
</div>
<div class="col-6">
<label for="endTime" class="form-label">Hora Fim</label>
<input type="time" class="form-control" id="endTime" required>
</div>
</div>
<div class="mb-3 mt-3">
<label for="scheduledBy" class="form-label">Agendado por</label>
<input type="text" class="form-control" id="scheduledBy" required>
</div>
<div class="mb-3">
<label for="description" class="form-label">Descrição (opcional)</label>
<textarea class="form-control" id="description" rows="3"></textarea>
</div>
<button type="submit" class="btn btn-primary w-100" id="submitReservationBtn">
<span class="btn-text">
<i class="fas fa-save me-2"></i>
Salvar Reserva
</span>
<div class="btn-spinner" style="display: none;"></div>
</button>
</form>
</div>
</div>
</div>

<!-- Reservations List -->
<div class="col-md-8">
<div class="card">
<div class="card-header d-flex justify-content-between align-items-center">
<h5 class="mb-0">
<i class="fas fa-list me-2"></i>
Lista de Reservas
</h5>
<button class="btn btn-success" onclick="loadReservations()">
<i class="fas fa-sync-alt me-1"></i>
Atualizar
</button>
</div>
<div class="card-body">
<div class="loading" id="loadingReservations">
<div class="spinner-border" role="status">
<span class="visually-hidden">Carregando...</span>
</div>
<p class="mt-2">Carregando reservas...</p>
</div>
<div class="table-responsive">
<table class="table table-hover">
<thead>
<tr>
<th>Cliente</th>
<th>Sala</th>
<th>Data</th>
<th>Horário</th>
<th>Agendado por</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="reservationsTableBody">
<!-- Reservations will be loaded here -->
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
`;
}

// Get calendar content for admin users
function getCalendarContent() {
return `
<div class="row">
<div class="col-12">
<div class="card">
<div class="card-header">
<h4 class="mb-0">
<i class="fas fa-calendar-alt me-2"></i>
Calendário de Reservas
</h4>
</div>
<div class="card-body">
<div id="calendar"></div>
</div>
</div>
</div>
</div>
`;
}

// Initialize the application
function initializeReservationApp() {
console.log("Inicializando aplicação de reservas...");

if (userType === 'admin') {
initializeCalendar();
loadReservations();
loadUsers(); // Load users
loadHistory(); // Load history
}

setupEventListeners();
}

// Initialize FullCalendar (only for admin)
function initializeCalendar() {
if (userType !== 'admin') return;

console.log("Inicializando calendário...");

// Aguardar um pouco para garantir que o DOM esteja pronto
setTimeout(() => {
const calendarEl = document.getElementById('calendar');
if (!calendarEl) {
console.error("Elemento #calendar não encontrado");
return;
}

console.log("Elemento calendário encontrado, criando instância...");

try {
calendar = new FullCalendar.Calendar(calendarEl, {
initialView: 'dayGridMonth',
locale: 'pt-br',
headerToolbar: {
left: 'prev,next today',
center: 'title',
right: 'dayGridMonth,timeGridWeek,timeGridDay'
},
buttonText: {
today: 'Hoje',
month: 'Mês',
week: 'Semana',
day: 'Dia'
},
events: [],
eventClick: function(info) {
showReservationDetails(info.event);
},
height: 'auto',
contentHeight: 600,
aspectRatio: 1.8,
// Forçar re-renderização após carregamento
eventDidMount: function() {
console.log("Evento montado no calendário");
},
// Callback quando o calendário é renderizado
viewDidMount: function() {
console.log("Vista do calendário montada");
}
});

console.log("Renderizando calendário...");
calendar.render();

// Forçar atualização após renderização inicial
setTimeout(() => {
if (calendar) {
console.log("Forçando atualização do calendário...");
calendar.updateSize();
calendar.render();
}
}, 500);

} catch (error) {
console.error("Erro ao inicializar calendário:", error);
}
}, 1000);
}

// Setup event listeners
function setupEventListeners() {
// Logout button with confirmation
document.getElementById('logoutBtn').addEventListener('click', async () => {
if (confirm('Tem certeza que deseja sair?')) {
try {
await signOut(auth);
showAlert('Logout realizado com sucesso!', 'success');

// Clear session data
sessionStorage.clear();
localStorage.removeItem('userLoggedIn');

setTimeout(() => {
window.location.href = "login.html";
}, 1000);
} catch (error) {
console.error("Erro ao fazer logout:", error);
showAlert('Erro ao fazer logout. Tente novamente.', 'danger');
}
}
});

// Adicionar evento para re-renderizar calendário quando aba for ativada
const calendarTab = document.getElementById('calendar-tab');
if (calendarTab && userType === 'admin') {
calendarTab.addEventListener('shown.bs.tab', function (e) {
console.log("Aba do calendário ativada, re-renderizando...");
setTimeout(() => {
if (calendar) {
calendar.updateSize();
calendar.render();
console.log("Calendário re-renderizado após ativação da aba");
}
}, 100);
});
}

// Reservation form (only for admin)
if (userType === 'admin') {
const reservationForm = document.getElementById('reservationForm');
if (reservationForm) {
reservationForm.addEventListener('submit', addReservation);
}

// Set minimum date to today
const today = new Date().toISOString().split('T')[0];
const reservationDate = document.getElementById('reservationDate');
const editReservationDate = document.getElementById('editReservationDate');

if (reservationDate) reservationDate.min = today;
if (editReservationDate) editReservationDate.min = today;

// Auto-fill scheduled by field with current user email
if (currentUser) {
const scheduledBy = document.getElementById('scheduledBy');
if (scheduledBy) scheduledBy.value = currentUser.email;
}

// Client search functionality
const clientSearch = document.getElementById('clientSearch');
if (clientSearch) {
clientSearch.addEventListener('input', filterClients);
}
}
}

// Filter clients by name
function filterClients() {
const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
const clientSelect = document.getElementById('clientName');
if (!clientSelect) return;

const selectedValue = clientSelect.value;
clientSelect.innerHTML = '<option value="">Selecione um cliente</option>';

usersData.forEach(user => {
if (user.name.toLowerCase().includes(searchTerm)) {
const option = document.createElement('option');
option.value = user.name;
option.textContent = user.name;
clientSelect.appendChild(option);
}
});

if (selectedValue) {
clientSelect.value = selectedValue;
}
}

// Update clients dropdown in edit modal
function updateEditClientsDropdown() {
const clientSelect = document.getElementById('editClientName');
if (!clientSelect) return;

clientSelect.innerHTML = '<option value="">Selecione um cliente</option>';

usersData.forEach(user => {
const option = document.createElement('option');
option.value = user.name;
option.textContent = user.name;
clientSelect.appendChild(option);
});
}

// Enhanced add reservation function with conflict checking (admin only)
async function addReservation(e) {
if (userType !== 'admin') return;

e.preventDefault();

console.log("Iniciando criação de reserva...");
setButtonLoading('submitReservationBtn', true);

try {
// Validate Firebase connection
if (!db || !currentUser) {
throw new Error("Conexão com Firebase não estabelecida ou usuário não autenticado");
}

const formData = {
clientName: document.getElementById('clientName').value.trim(),
roomName: document.getElementById('roomName').value,
reservationDate: document.getElementById('reservationDate').value,
startTime: document.getElementById('startTime').value,
endTime: document.getElementById('endTime').value,
scheduledBy: document.getElementById('scheduledBy').value.trim(),
description: document.getElementById('description').value.trim(),
createdAt: new Date(),
createdBy: currentUser.email
};

console.log("Dados do formulário:", formData);

// Enhanced validation
if (!formData.clientName || !formData.roomName || !formData.scheduledBy) {
showAlert('Por favor, preencha todos os campos obrigatórios.', 'danger');
return;
}

if (!formData.reservationDate || !formData.startTime || !formData.endTime) {
showAlert('Por favor, defina data e horários.', 'danger');
return;
}

if (formData.startTime >= formData.endTime) {
showAlert('A hora de início deve ser anterior à hora de fim.', 'danger');
return;
}

// Check for conflicts (same room, same date, overlapping time)
const hasConflict = await checkReservationConflict(formData);
if (hasConflict) {
showAlert('Já existe uma reserva para esta sala no horário selecionado.', 'danger');
return;
}

console.log("Validações passaram, criando documento no Firestore...");

const docRef = await addDoc(collection(db, "reservations"), formData);
console.log("Documento criado com ID:", docRef.id);

showAlert('Reserva criada com sucesso!', 'success');
document.getElementById('reservationForm').reset();

// Reset scheduled by field
document.getElementById('scheduledBy').value = currentUser.email;

// Reload data
await loadReservations();
await loadCalendarEvents();
await loadHistory(); // Reload history

} catch (error) {
console.error("Erro detalhado ao criar reserva:", error);

let errorMessage = 'Erro ao criar reserva. ';

if (error.code === 'permission-denied') {
errorMessage += 'Permissão negada. Verifique as regras do Firestore.';
} else if (error.code === 'unavailable') {
errorMessage += 'Serviço temporariamente indisponível. Tente novamente.';
} else if (error.message.includes('Firebase')) {
errorMessage += 'Problema de conexão com o banco de dados.';
} else {
errorMessage += error.message || 'Tente novamente.';
}

showAlert(errorMessage, 'danger');
} finally {
setButtonLoading('submitReservationBtn', false);
}
}

// Check for reservation conflicts (admin only)
async function checkReservationConflict(newReservation, excludeId = null) {
if (userType !== 'admin') return false;

try {
const q = query(collection(db, "reservations"));
const querySnapshot = await getDocs(q);

for (const doc of querySnapshot.docs) {
if (excludeId && doc.id === excludeId) continue;

const reservation = doc.data();

// Check if same room and same date
if (reservation.roomName === newReservation.roomName && 
reservation.reservationDate === newReservation.reservationDate) {

// Check for time overlap
const existingStart = reservation.startTime;
const existingEnd = reservation.endTime;
const newStart = newReservation.startTime;
const newEnd = newReservation.endTime;

if ((newStart < existingEnd && newEnd > existingStart)) {
return true; // Conflict found
}
}
}

return false; // No conflict
} catch (error) {
console.error("Erro ao verificar conflitos:", error);
return false; // Assume no conflict on error
}
}

// Load users from Firestore with enhanced error handling and retry
async function loadUsers(retryCount = 0) {
if (userType !== 'admin') return;

const loadingEl = document.getElementById('loadingUsers');
const tableBody = document.getElementById('usersTableBody');

if (!loadingEl || !tableBody) return;

loadingEl.style.display = 'block';
tableBody.innerHTML = '';

try {
console.log(`Carregando usuários... (tentativa ${retryCount + 1})`);

// Test connectivity first
const isConnected = await testFirebaseConnectivity();
if (!isConnected) {
throw new Error("Falha na conectividade com Firebase");
}

// Clear previous data
usersData.clear();

// Create query with timeout
const q = query(collection(db, "users"), orderBy("createdAt", "desc"));

// Set a timeout for the operation
const timeoutPromise = new Promise((_, reject) => {
setTimeout(() => reject(new Error('timeout')), 15000); // 15 seconds timeout
});

const querySnapshot = await Promise.race([
getDocs(q),
timeoutPromise
]);

console.log(`${querySnapshot.size} usuários encontrados`);

if (querySnapshot.empty) {
// Check if collection exists by trying to create a test document
try {
const testQuery = query(collection(db, "users"));
await getDocs(testQuery);
tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhum usuário cadastrado ainda</td></tr>';
} catch (collectionError) {
console.error("Coleção 'users' pode não existir:", collectionError);
tableBody.innerHTML = `
<tr>
<td colspan="4" class="text-center text-warning">
<i class="fas fa-exclamation-triangle me-2"></i>
Coleção de usuários não encontrada. 
<br><small>Contate o administrador para configurar o banco de dados.</small>
</td>
</tr>
`;
}
} else {
querySnapshot.forEach((doc) => {
const user = doc.data();

// Validate user data structure
if (user.name && user.email) {
usersData.set(doc.id, user);
const row = createUserRow(doc.id, user);
tableBody.appendChild(row);
} else {
console.warn("Documento de usuário com estrutura inválida:", doc.id, user);
}
});

// Show success message if this was a retry
if (retryCount > 0) {
showAlert('Usuários carregados com sucesso!', 'success');
}
}

// Update clients dropdown in reservation form
filterClients();
// Update clients dropdown in edit modal
updateEditClientsDropdown();

} catch (error) {
console.error("Erro ao carregar usuários:", error);

const errorMessage = getFirebaseErrorMessage(error);

// Show specific error message
showAlert(errorMessage, 'danger');

// Create retry button in table
const retryButton = retryCount < 2 ? `
<button class="btn btn-primary btn-sm mt-2" onclick="loadUsers(${retryCount + 1})">
<i class="fas fa-sync-alt me-1"></i>
Tentar Novamente
</button>
` : `
<button class="btn btn-secondary btn-sm mt-2" onclick="location.reload()">
<i class="fas fa-refresh me-1"></i>
Recarregar Página
</button>
`;

tableBody.innerHTML = `
<tr>
<td colspan="4" class="text-center text-danger">
<i class="fas fa-exclamation-circle me-2"></i>
Erro ao carregar usuários
<br><small class="text-muted">${errorMessage}</small>
<br>${retryButton}
</td>
</tr>
`;

// Auto-retry for network errors (up to 2 times)
if (retryCount < 2 && (error.code === 'unavailable' || error.code === 'timeout' || error.message.includes('network'))) {
console.log(`Auto-retry em 3 segundos... (tentativa ${retryCount + 2})`);
setTimeout(() => {
loadUsers(retryCount + 1);
}, 3000);
}
} finally {
loadingEl.style.display = 'none';
}
}

function createUserRow(id, user) {
const row = document.createElement('tr');
const createdAt = user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt);
const formattedDate = createdAt.toLocaleDateString('pt-BR');

row.innerHTML = `
<td>${user.name}</td>
<td>${user.email}</td>
<td>${formattedDate}</td>
<td>
<button class="btn btn-warning btn-sm me-1" onclick="editUser('${id}')" title="Editar usuário">
<i class="fas fa-edit"></i>
</button>
<button class="btn btn-danger btn-sm" onclick="deleteUser('${id}')" title="Excluir usuário">
<i class="fas fa-trash"></i>
</button>
</td>
`;

return row;
}

// Edit user function
window.editUser = async function(id) {
if (userType !== 'admin') return;

try {
let userData = usersData.get(id);

if (!userData) {
const docRef = doc(db, "users", id);
const docSnap = await getDoc(docRef);

if (docSnap.exists()) {
userData = docSnap.data();
usersData.set(id, userData);
} else {
showAlert('Usuário não encontrado.', 'danger');
return;
}
}

// Fill edit form
document.getElementById('editUserId').value = id;
document.getElementById('editUserName').value = userData.name || '';
document.getElementById('editUserEmail').value = userData.email || '';

const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
modal.show();
} catch (error) {
console.error("Erro ao carregar usuário para edição:", error);
showAlert('Erro ao carregar dados do usuário.', 'danger');
}
};

// Update user function
window.updateUser = async function() {
if (userType !== 'admin') return;

setButtonLoading('updateUserBtn', true);

try {
const id = document.getElementById('editUserId').value;
const formData = {
name: document.getElementById('editUserName').value.trim(),
email: document.getElementById('editUserEmail').value.trim(),
updatedAt: new Date(),
updatedBy: currentUser.email
};

// Validate required fields
if (!formData.name || !formData.email) {
showAlert('Por favor, preencha todos os campos obrigatórios.', 'danger');
return;
}

// Validate email format
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
if (!emailRegex.test(formData.email)) {
showAlert('Por favor, insira um email válido.', 'danger');
return;
}

// Check if email is already in use by another user
const usersQuery = query(collection(db, "users"));
const usersSnapshot = await getDocs(usersQuery);
let emailExists = false;

usersSnapshot.forEach((doc) => {
if (doc.id !== id && doc.data().email === formData.email) {
emailExists = true;
}
});

if (emailExists) {
showAlert('Este email já está sendo usado por outro usuário.', 'danger');
return;
}

const docRef = doc(db, "users", id);
await updateDoc(docRef, formData);
showAlert('Usuário atualizado com sucesso!', 'success');

const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
modal.hide();

await loadUsers();

} catch (error) {
console.error("Erro ao atualizar usuário:", error);
showAlert('Erro ao atualizar usuário. Tente novamente.', 'danger');
} finally {
setButtonLoading('updateUserBtn', false);
}
};

// Delete user function
window.deleteUser = async function(id) {
if (userType !== 'admin') return;

const userData = usersData.get(id);
if (!userData) {
showAlert('Usuário não encontrado.', 'danger');
return;
}

// Prevent admin from deleting themselves
if (userData.email === currentUser.email) {
showAlert('Você não pode excluir sua própria conta.', 'danger');
return;
}

if (confirm(`Tem certeza que deseja excluir o usuário "${userData.name}"? Esta ação não pode ser desfeita.`)) {
try {
console.log("Excluindo usuário:", id);

// Delete from Firestore
await deleteDoc(doc(db, "users", id));

// Remove from local cache
usersData.delete(id);

showAlert('Usuário excluído com sucesso!', 'success');

// Reload users
await loadUsers();
} catch (error) {
console.error("Erro ao excluir usuário:", error);
showAlert('Erro ao excluir usuário. Tente novamente.', 'danger');
}
}
};

// Load reservations with enhanced error handling and retry (admin only)
async function loadReservations(retryCount = 0) {
if (userType !== 'admin') return;

const loadingEl = document.getElementById('loadingReservations');
const tableBody = document.getElementById('reservationsTableBody');

if (!loadingEl || !tableBody) return;

loadingEl.style.display = 'block';
tableBody.innerHTML = '';

try {
console.log(`Carregando reservas... (tentativa ${retryCount + 1})`);

// Test connectivity first
const isConnected = await testFirebaseConnectivity();
if (!isConnected) {
throw new Error("Falha na conectividade com Firebase");
}

// Clear previous data
reservationsData.clear();

// Create query with timeout
const q = query(collection(db, "reservations"), orderBy("reservationDate", "desc"));

// Set a timeout for the operation
const timeoutPromise = new Promise((_, reject) => {
setTimeout(() => reject(new Error('timeout')), 15000); // 15 seconds timeout
});

const querySnapshot = await Promise.race([
getDocs(q),
timeoutPromise
]);

console.log(`${querySnapshot.size} reservas encontradas`);

if (querySnapshot.empty) {
tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhuma reserva encontrada</td></tr>';
} else {
querySnapshot.forEach((doc) => {
const reservation = doc.data();

// Validate reservation data structure
if (reservation.clientName && reservation.roomName && reservation.reservationDate) {
reservationsData.set(doc.id, reservation);
const row = createReservationRow(doc.id, reservation);
tableBody.appendChild(row);
} else {
console.warn("Documento de reserva com estrutura inválida:", doc.id, reservation);
}
});

// Show success message if this was a retry
if (retryCount > 0) {
showAlert('Reservas carregadas com sucesso!', 'success');
}
}

await loadCalendarEvents();

} catch (error) {
console.error("Erro ao carregar reservas:", error);

const errorMessage = getFirebaseErrorMessage(error);

// Show specific error message
showAlert(errorMessage, 'danger');

// Create retry button in table
const retryButton = retryCount < 2 ? `
<button class="btn btn-primary btn-sm mt-2" onclick="loadReservations(${retryCount + 1})">
<i class="fas fa-sync-alt me-1"></i>
Tentar Novamente
</button>
` : `
<button class="btn btn-secondary btn-sm mt-2" onclick="location.reload()">
<i class="fas fa-refresh me-1"></i>
Recarregar Página
</button>
`;

tableBody.innerHTML = `
<tr>
<td colspan="6" class="text-center text-danger">
<i class="fas fa-exclamation-circle me-2"></i>
Erro ao carregar reservas
<br><small class="text-muted">${errorMessage}</small>
<br>${retryButton}
</td>
</tr>
`;

// Auto-retry for network errors (up to 2 times)
if (retryCount < 2 && (error.code === 'unavailable' || error.code === 'timeout' || error.message.includes('network'))) {
console.log(`Auto-retry em 3 segundos... (tentativa ${retryCount + 2})`);
setTimeout(() => {
loadReservations(retryCount + 1);
}, 3000);
}
} finally {
loadingEl.style.display = 'none';
}
}

// Create reservation table row with better formatting (admin only)
function createReservationRow(id, reservation) {
const row = document.createElement('tr');
const date = new Date(reservation.reservationDate + 'T00:00:00');
const formattedDate = date.toLocaleDateString('pt-BR');

// Check if reservation is in the past
const today = new Date();
const reservationDateTime = new Date(reservation.reservationDate + 'T' + reservation.endTime);
const isPast = reservationDateTime < today;

row.innerHTML = `
<td>${reservation.clientName}</td>
<td>
<span class="badge bg-secondary">${reservation.roomName}</span>
</td>
<td>${formattedDate}</td>
<td>
<small class="text-muted">${reservation.startTime} - ${reservation.endTime}</small>
</td>
<td>
<small>${reservation.scheduledBy}</small>
</td>
<td>
<button class="btn btn-warning btn-sm me-1" onclick="editReservation('${id}')" ${isPast ? 'disabled title="Reserva já finalizada"' : ''}>
<i class="fas fa-edit"></i>
</button>
<button class="btn btn-danger btn-sm" onclick="deleteReservation('${id}')" ${isPast ? 'disabled title="Reserva já finalizada"' : ''}>
<i class="fas fa-trash"></i>
</button>
</td>
`;

if (isPast) {
row.classList.add('table-secondary');
}

return row;
}

// Load history of past reservations with enhanced error handling
async function loadHistory(retryCount = 0) {
if (userType !== 'admin') return;

const loadingEl = document.getElementById('loadingHistory');
const tableBody = document.getElementById('historyTableBody');

if (!loadingEl || !tableBody) return;

loadingEl.style.display = 'block';
tableBody.innerHTML = '';

try {
console.log(`Carregando histórico de reservas... (tentativa ${retryCount + 1})`);

// Test connectivity first
const isConnected = await testFirebaseConnectivity();
if (!isConnected) {
throw new Error("Falha na conectividade com Firebase");
}

const today = new Date();
today.setHours(0, 0, 0, 0); // Consider only date

// Create query with timeout
const q = query(collection(db, "reservations"), orderBy("reservationDate", "desc"));

// Set a timeout for the operation
const timeoutPromise = new Promise((_, reject) => {
setTimeout(() => reject(new Error('timeout')), 15000); // 15 seconds timeout
});

const querySnapshot = await Promise.race([
getDocs(q),
timeoutPromise
]);

console.log(`${querySnapshot.size} reservas encontradas no total`);

if (querySnapshot.empty) {
tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhuma reserva histórica encontrada</td></tr>';
} else {
let hasHistory = false;
querySnapshot.forEach((doc) => {
const reservation = doc.data();

// Validate reservation data structure
if (reservation.clientName && reservation.roomName && reservation.reservationDate) {
const reservationDate = new Date(reservation.reservationDate + 'T00:00:00');
            
// Check if it's a past reservation
if (reservationDate < today) {
const row = createHistoryRow(doc.id, reservation);
tableBody.appendChild(row);
hasHistory = true;
}
} else {
console.warn("Documento de reserva histórica com estrutura inválida:", doc.id, reservation);
}
});

if (!hasHistory) {
tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhuma reserva histórica encontrada</td></tr>';
} else if (retryCount > 0) {
// Show success message if this was a retry
showAlert('Histórico carregado com sucesso!', 'success');
}
}

} catch (error) {
console.error("Erro ao carregar histórico:", error);

const errorMessage = getFirebaseErrorMessage(error);

// Show specific error message
showAlert(errorMessage, 'danger');

// Create retry button in table
const retryButton = retryCount < 2 ? `
<button class="btn btn-primary btn-sm mt-2" onclick="loadHistory(${retryCount + 1})">
<i class="fas fa-sync-alt me-1"></i>
Tentar Novamente
</button>
` : `
<button class="btn btn-secondary btn-sm mt-2" onclick="location.reload()">
<i class="fas fa-refresh me-1"></i>
Recarregar Página
</button>
`;

tableBody.innerHTML = `
<tr>
<td colspan="6" class="text-center text-danger">
<i class="fas fa-exclamation-circle me-2"></i>
Erro ao carregar histórico de reservas
<br><small class="text-muted">${errorMessage}</small>
<br>${retryButton}
</td>
</tr>
`;

// Auto-retry for network errors (up to 2 times)
if (retryCount < 2 && (error.code === 'unavailable' || error.code === 'timeout' || error.message.includes('network'))) {
console.log(`Auto-retry em 3 segundos... (tentativa ${retryCount + 2})`);
setTimeout(() => {
loadHistory(retryCount + 1);
}, 3000);
}
} finally {
loadingEl.style.display = 'none';
}
}

// Create history table row
function createHistoryRow(id, reservation) {
const row = document.createElement('tr');
const date = new Date(reservation.reservationDate + 'T00:00:00');
const formattedDate = date.toLocaleDateString('pt-BR');
const reservationEnd = new Date(reservation.reservationDate + 'T' + reservation.endTime);
const now = new Date();
const isCompleted = reservationEnd < now;

row.classList.add('reservation-history');
row.innerHTML = `
<td>${reservation.clientName}</td>
<td>
<span class="badge badge-history">${reservation.roomName}</span>
</td>
<td>${formattedDate}</td>
<td>
<small class="text-muted">${reservation.startTime} - ${reservation.endTime}</small>
</td>
<td>
<span class="badge ${isCompleted ? 'bg-success' : 'bg-warning'}">
${isCompleted ? 'Concluída' : 'Em andamento'}
</span>
</td>
<td>
<button class="btn btn-warning btn-sm me-1" onclick="editReservation('${id}')">
<i class="fas fa-edit"></i>
</button>
<button class="btn btn-danger btn-sm" onclick="deleteReservation('${id}')">
<i class="fas fa-trash"></i>
</button>
</td>
`;

return row;
}

// Load calendar events with better colors (admin only)
async function loadCalendarEvents() {
if (userType !== 'admin' || !calendar) return;

try {
const events = [];
const roomColors = {
'Sala de Reunião A': '#d4c4b0',
'Sala de Reunião B': '#c4b49f',
'Sala de Conferência': '#b3a48e',
'Auditório': '#a8c686',
'Sala de Treinamento': '#8fb069'
};

reservationsData.forEach((reservation, id) => {
const startDateTime = `${reservation.reservationDate}T${reservation.startTime}`;
const endDateTime = `${reservation.reservationDate}T${reservation.endTime}`;

events.push({
id: id,
title: `${reservation.roomName} - ${reservation.clientName}`,
start: startDateTime,
end: endDateTime,
backgroundColor: roomColors[reservation.roomName] || '#d4c4b0',
borderColor: roomColors[reservation.roomName] || '#d4c4b0',
extendedProps: {
clientName: reservation.clientName,
roomName: reservation.roomName,
scheduledBy: reservation.scheduledBy,
description: reservation.description || 'Sem descrição'
}
});
});

calendar.removeAllEvents();
calendar.addEventSource(events);
} catch (error) {
console.error("Erro ao carregar eventos do calendário:", error);
}
}

// Enhanced reservation details display (admin only)
function showReservationDetails(event) {
if (userType !== 'admin') return;

const props = event.extendedProps;
const startTime = event.start.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
const endTime = event.end.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
const date = event.start.toLocaleDateString('pt-BR');

showAlert(`
<strong>Detalhes da Reserva:</strong><br><br>
<strong>Cliente:</strong> ${props.clientName}<br>
<strong>Sala:</strong> ${props.roomName}<br>
<strong>Data:</strong> ${date}<br>
<strong>Horário:</strong> ${startTime} - ${endTime}<br>
<strong>Agendado por:</strong> ${props.scheduledBy}<br>
<strong>Descrição:</strong> ${props.description}
`, 'info');
}

// Edit reservation with conflict checking (admin only)
window.editReservation = async function(id) {
if (userType !== 'admin') return;

try {
let reservationData = reservationsData.get(id);

if (!reservationData) {
const docRef = doc(db, "reservations", id);
const docSnap = await getDoc(docRef);

if (docSnap.exists()) {
reservationData = docSnap.data();
reservationsData.set(id, reservationData);
} else {
showAlert('Reserva não encontrada.', 'danger');
return;
}
}

// Fill edit form
document.getElementById('editReservationId').value = id;
document.getElementById('editClientName').value = reservationData.clientName || '';
document.getElementById('editRoomName').value = reservationData.roomName || '';
document.getElementById('editReservationDate').value = reservationData.reservationDate || '';
document.getElementById('editStartTime').value = reservationData.startTime || '';
document.getElementById('editEndTime').value = reservationData.endTime || '';
document.getElementById('editScheduledBy').value = reservationData.scheduledBy || '';
document.getElementById('editDescription').value = reservationData.description || '';

const modal = new bootstrap.Modal(document.getElementById('editReservationModal'));
modal.show();
} catch (error) {
console.error("Erro ao carregar reserva para edição:", error);
showAlert('Erro ao carregar dados da reserva.', 'danger');
}
};

// Update reservation with conflict checking (admin only)
window.updateReservation = async function() {
if (userType !== 'admin') return;

setButtonLoading('updateReservationBtn', true);

try {
const id = document.getElementById('editReservationId').value;
const formData = {
clientName: document.getElementById('editClientName').value.trim(),
roomName: document.getElementById('editRoomName').value,
reservationDate: document.getElementById('editReservationDate').value,
startTime: document.getElementById('editStartTime').value,
endTime: document.getElementById('editEndTime').value,
scheduledBy: document.getElementById('editScheduledBy').value.trim(),
description: document.getElementById('editDescription').value.trim(),
updatedAt: new Date(),
updatedBy: currentUser.email
};

// Validate time
if (formData.startTime >= formData.endTime) {
showAlert('A hora de início deve ser anterior à hora de fim.', 'danger');
return;
}

// Validate required fields
if (!formData.clientName || !formData.roomName || !formData.scheduledBy) {
showAlert('Por favor, preencha todos os campos obrigatórios.', 'danger');
return;
}

// Check for conflicts (excluding current reservation)
const hasConflict = await checkReservationConflict(formData, id);
if (hasConflict) {
showAlert('Já existe uma reserva para esta sala no horário selecionado.', 'danger');
return;
}

const docRef = doc(db, "reservations", id);
await updateDoc(docRef, formData);
showAlert('Reserva atualizada com sucesso!', 'success');

const modal = bootstrap.Modal.getInstance(document.getElementById('editReservationModal'));
modal.hide();

await loadReservations();
await loadCalendarEvents();
await loadHistory(); // Reload history

} catch (error) {
console.error("Erro ao atualizar reserva:", error);
showAlert('Erro ao atualizar reserva. Tente novamente.', 'danger');
} finally {
setButtonLoading('updateReservationBtn', false);
}
};

// Delete reservation with confirmation (admin only)
window.deleteReservation = async function(id) {
if (userType !== 'admin') return;

if (confirm('Tem certeza que deseja excluir esta reserva? Esta ação não pode ser desfeita.')) {
try {
console.log("Excluindo reserva:", id);

// Delete from Firestore
await deleteDoc(doc(db, "reservations", id));

// Remove from local cache
reservationsData.delete(id);

showAlert('Reserva excluída com sucesso!', 'success');

// Reload reservations and calendar
await loadReservations();
await loadCalendarEvents();
await loadHistory(); // Reload history
} catch (error) {
console.error("Erro ao excluir reserva:", error);
showAlert('Erro ao excluir reserva. Tente novamente.', 'danger');
}
}
};

// Initialize new slider
function initializeNewSlider() {
    const slider = document.getElementById('sliderImages');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    if (!slider || !prevBtn || !nextBtn) return;
    
    let isDown = false;
    let startX;
    let scrollLeft;
    
    // Função para calcular o tamanho do slide dinamicamente
    function getSlideWidth() {
        const slides = slider.querySelectorAll('.slider-img');
        if (slides.length > 0) {
            const slideStyle = window.getComputedStyle(slides[0]);
            const slideWidth = parseFloat(slideStyle.width);
            const marginRight = parseFloat(slideStyle.marginRight) || 0;
            const gap = 15; // gap definido no CSS
            return slideWidth + gap;
        }
        return 315; // fallback
    }
    
    // Função para atualizar o estado dos botões
    function updateButtonStates() {
        const maxScroll = slider.scrollWidth - slider.clientWidth;
        const currentScroll = slider.scrollLeft;
        
        // Atualizar estado do botão anterior
        if (currentScroll <= 0) {
            prevBtn.style.opacity = '0.5';
            prevBtn.style.cursor = 'not-allowed';
        } else {
            prevBtn.style.opacity = '1';
            prevBtn.style.cursor = 'pointer';
        }
        
        // Atualizar estado do botão próximo
        if (currentScroll >= maxScroll - 1) { // -1 para compensar arredondamentos
            nextBtn.style.opacity = '0.5';
            nextBtn.style.cursor = 'not-allowed';
        } else {
            nextBtn.style.opacity = '1';
            nextBtn.style.cursor = 'pointer';
        }
    }
    
    // Função para rolar o slider
    function scrollSlider(direction) {
        const slideWidth = getSlideWidth();
        const maxScroll = slider.scrollWidth - slider.clientWidth;
        const currentScroll = slider.scrollLeft;
        
        let newScrollPosition;
        
        if (direction === 'next') {
            newScrollPosition = Math.min(currentScroll + slideWidth, maxScroll);
        } else {
            newScrollPosition = Math.max(currentScroll - slideWidth, 0);
        }
        
        slider.scrollTo({
            left: newScrollPosition,
            behavior: 'smooth'
        });
    }
    
    // Adiciona eventos aos botões
    prevBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (slider.scrollLeft > 0) {
            scrollSlider('prev');
        }
    });
    
    nextBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const maxScroll = slider.scrollWidth - slider.clientWidth;
        if (slider.scrollLeft < maxScroll - 1) {
            scrollSlider('next');
        }
    });
    
    // Evento de scroll para atualizar estados dos botões
    slider.addEventListener('scroll', () => {
        updateButtonStates();
    });
    
    // Eventos de mouse para arrastar
    slider.addEventListener('mousedown', (e) => {
        isDown = true;
        slider.style.cursor = 'grabbing';
        startX = e.pageX - slider.offsetLeft;
        scrollLeft = slider.scrollLeft;
        e.preventDefault();
    });
    
    slider.addEventListener('mouseleave', () => {
        isDown = false;
        slider.style.cursor = 'grab';
    });
    
    slider.addEventListener('mouseup', () => {
        isDown = false;
        slider.style.cursor = 'grab';
    });
    
    slider.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - slider.offsetLeft;
        const walk = (x - startX) * 2;
        slider.scrollLeft = scrollLeft - walk;
    });
    
    // Eventos de touch para dispositivos móveis
    let touchStartX = 0;
    let touchScrollLeft = 0;
    
    slider.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchScrollLeft = slider.scrollLeft;
    }, { passive: true });
    
    slider.addEventListener('touchmove', (e) => {
        if (!touchStartX) return;
        const touchX = e.touches[0].clientX;
        const diff = touchStartX - touchX;
        slider.scrollLeft = touchScrollLeft + diff;
    }, { passive: true });
    
    slider.addEventListener('touchend', () => {
        touchStartX = 0;
    }, { passive: true });
    
    // Evento de redimensionamento da janela
    window.addEventListener('resize', () => {
        updateButtonStates();
    });
    
    // Inicializar estados dos botões
    setTimeout(() => {
        updateButtonStates();
        slider.style.cursor = 'grab';
    }, 100);
}

// Make functions available globally
window.loadReservations = loadReservations;
window.loadUsers = loadUsers;
window.loadHistory = loadHistory;

// Initialize Firebase when page loads
initializeFirebase();

// Handle page visibility change to refresh data when user returns (admin only)
document.addEventListener('visibilitychange', () => {
if (!document.hidden && currentUser && userType === 'admin') {
loadReservations();
loadUsers();
loadHistory();
}
});
</script>
</body>
</html>

